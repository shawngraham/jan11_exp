<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whitechapel in Shawville | Interactive Exploration</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --color-bg: #f5f1e8;
            --color-paper: #fdfbf7;
            --color-ink: #2c2416;
            --color-ink-light: #6b5f4f;
            --color-ripper: #8b0000;
            --color-london: #191970;
            --color-shawville: #228b22;
        }

        body {
            font-family: 'Crimson Text', Georgia, 'Times New Roman', serif;
            background: var(--color-bg);
            color: var(--color-ink);
            line-height: 1.7;
            font-size: 18px;
        }

        header {
            background: var(--color-ink);
            color: var(--color-paper);
            padding: 3rem 2rem;
            text-align: center;
        }

        h1 {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 3.5rem;
            font-weight: 900;
            margin-bottom: 0.5rem;
            letter-spacing: 0.02em;
        }

        h2, h3 {
            font-family: 'Playfair Display', Georgia, serif;
        }

        h2 {
            font-weight: 700;
        }

        .subtitle {
            font-size: 1.2rem;
            font-style: italic;
            color: #d4c5a9;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .section {
            background: var(--color-paper);
            padding: 2rem;
            margin: 2rem 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .section h2 {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--color-ripper);
            border-bottom: 3px solid var(--color-ripper);
            padding-bottom: 0.5rem;
        }

        /* Timeline */
        .timeline {
            position: relative;
            padding: 2rem 0;
        }

        .timeline-track {
            position: relative;
            margin: 2rem 0;
        }

        .timeline-label {
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .timeline-label.london { color: var(--color-london); }
        .timeline-label.shawville { color: var(--color-shawville); }

        .timeline-line {
            height: 4px;
            background: #ddd;
            position: relative;
            margin: 1rem 0;
        }

        .timeline-events {
            position: relative;
            min-height: 80px;
        }

        .timeline-event {
            position: absolute;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .timeline-event:hover {
            transform: scale(1.1);
            z-index: 10;
        }

        .event-marker {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .event-marker.london { background: var(--color-london); }
        .event-marker.shawville { background: var(--color-shawville); }
        .event-marker.murder {
            background: var(--color-ripper);
            box-shadow: 0 0 8px rgba(139, 0, 0, 0.6);
        }

        .event-label {
            position: absolute;
            top: 25px;
            left: -40px;
            width: 100px;
            font-size: 0.7rem;
            text-align: center;
            line-height: 1.2;
            pointer-events: none;
        }

        /* Article Cards */
        .article-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .article-card {
            background: white;
            border: 2px solid #ddd;
            border-radius: 6px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .article-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-color: var(--color-ripper);
        }

        .article-card.whitechapel {
            border-color: var(--color-ripper);
            background: #fff5f5;
        }

        .article-card.burke-hare {
            border-color: #8B4513;
            background: #fff9f0;
        }

        .article-card.local-violence {
            border-color: var(--color-shawville);
            background: #f5fff5;
        }

        .article-card .badge {
            display: inline-block;
            background: var(--color-ripper);
            color: white;
            padding: 0.25rem 0.75rem;
            font-size: 0.7rem;
            border-radius: 3px;
            margin-bottom: 0.5rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .article-card h3 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--color-ink);
        }

        .article-card .meta {
            font-size: 0.85rem;
            color: var(--color-ink-light);
            margin-bottom: 0.75rem;
        }

        .article-card .snippet {
            font-size: 0.9rem;
            color: var(--color-ink);
            line-height: 1.5;
        }

        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }

        .stat-box {
            text-align: center;
            padding: 2rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 3rem;
            font-weight: bold;
            color: var(--color-ripper);
        }

        .stat-label {
            font-size: 1rem;
            color: var(--color-ink-light);
            margin-top: 0.5rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal-content {
            background: var(--color-paper);
            max-width: 800px;
            width: 100%;
            border-radius: 8px;
            padding: 2rem;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 2rem;
            cursor: pointer;
            background: none;
            border: none;
            color: var(--color-ink-light);
            padding: 0.5rem;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--color-ripper);
        }

        .modal h2 {
            margin-bottom: 1rem;
            color: var(--color-ripper);
        }

        .modal .meta {
            font-size: 0.9rem;
            color: var(--color-ink-light);
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #ddd;
        }

        .modal .text {
            font-size: 1.1rem;
            line-height: 1.8;
            text-align: justify;
        }

        /* Modal view toggle */
        .view-toggle {
            display: flex;
            gap: 1rem;
            margin: 1.5rem 0;
            padding: 0.5rem;
            background: #f5f5f5;
            border-radius: 4px;
        }

        .view-toggle-btn {
            flex: 1;
            padding: 0.75rem 1.5rem;
            border: 2px solid transparent;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            font-family: 'Crimson Text', serif;
        }

        .view-toggle-btn:hover {
            background: var(--color-paper);
            border-color: var(--color-ink-light);
        }

        .view-toggle-btn.active {
            background: var(--color-ripper);
            color: white;
            border-color: var(--color-ripper);
        }

        .modal-view {
            display: none;
        }

        .modal-view.active {
            display: block;
        }

        .image-view {
            text-align: center;
            padding: 1rem;
            background: #f9f9f9;
            border-radius: 4px;
        }

        .image-view img {
            max-width: 100%;
            height: auto;
            border: 2px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            cursor: zoom-in;
            transition: transform 0.3s;
        }

        .image-view img:hover {
            transform: scale(1.02);
        }

        .image-view img.zoomed {
            cursor: zoom-out;
            max-width: none;
            width: auto;
            max-height: 80vh;
        }

        .image-view .image-caption {
            margin-top: 1rem;
            font-size: 0.9rem;
            color: var(--color-ink-light);
            font-style: italic;
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid var(--color-ink-light);
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            background: var(--color-ink);
            color: white;
        }

        .filter-btn.active {
            background: var(--color-ripper);
            color: white;
            border-color: var(--color-ripper);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 4rem;
            font-size: 1.2rem;
            color: var(--color-ink-light);
        }

        /* Word Cloud */
        .word-cloud {
            text-align: center;
            padding: 3rem 2rem;
            line-height: 3;
            background: linear-gradient(135deg, #fdfbf7 0%, #f9f6ef 100%);
            border-radius: 8px;
        }

        .word-cloud span {
            display: inline-block;
            margin: 0.75rem;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--color-ink);
            font-family: 'Playfair Display', serif;
            font-weight: 600;
            border-radius: 4px;
            position: relative;
        }

        .word-cloud span::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 2px;
            background: var(--color-ripper);
            transition: all 0.3s;
            transform: translateX(-50%);
        }

        .word-cloud span:hover {
            color: var(--color-ripper);
            transform: scale(1.15) translateY(-2px);
            text-shadow: 0 2px 8px rgba(139, 0, 0, 0.2);
        }

        .word-cloud span:hover::before {
            width: 100%;
        }

        /* Geographic Map */
        .geo-map {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .location-box {
            background: white;
            border-radius: 6px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
            cursor: pointer;
        }

        .location-box:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .location-box.london { border-left: 4px solid var(--color-ripper); }
        .location-box.edinburgh { border-left: 4px solid #8B4513; }
        .location-box.shawville { border-left: 4px solid var(--color-shawville); }
        .location-box.international { border-left: 4px solid var(--color-london); }
        .location-box.canadian { border-left: 4px solid #DC143C; }

        .location-name {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: var(--color-ink);
        }

        .location-count {
            font-size: 2rem;
            font-weight: bold;
            color: var(--color-ripper);
            margin: 0.5rem 0;
        }

        .location-desc {
            font-size: 0.85rem;
            color: var(--color-ink-light);
            font-style: italic;
        }

        .location-bar {
            height: 8px;
            background: var(--color-paper-dark);
            border-radius: 4px;
            margin-top: 1rem;
            overflow: hidden;
        }

        .location-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-ripper), #d4af37);
            transition: width 0.6s ease;
        }

        /* Network Graph */
        .network-container {
            position: relative;
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 2rem;
            min-height: 600px;
        }

        #network-svg {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .network-node {
            cursor: pointer;
            transition: all 0.3s;
        }

        .network-node:hover {
            stroke-width: 3px;
        }

        .network-node.person {
            fill: var(--color-ripper);
            stroke: #8b0000;
        }

        .network-node.place {
            fill: var(--color-shawville);
            stroke: #228b22;
        }

        .network-link {
            stroke: #999;
            stroke-opacity: 0.3;
        }

        .network-link.person-person {
            stroke: #d4af37;
            stroke-opacity: 0.4;
            stroke-dasharray: 3,3;
        }

        .network-link.person-place {
            stroke: #999;
            stroke-opacity: 0.3;
        }

        .network-label {
            font-size: 10px;
            pointer-events: none;
            fill: var(--color-ink);
            font-family: Arial, sans-serif;
        }

        .network-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .network-control-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #ccc;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .network-control-btn:hover {
            background: var(--color-ink);
            color: white;
        }

        .network-control-btn.active {
            background: var(--color-ripper);
            color: white;
            border-color: var(--color-ripper);
        }

        .network-legend {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
            margin-top: 1rem;
            padding: 1rem;
            background: #f9f9f9;
            border-radius: 4px;
        }

        .network-legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .network-legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .network-legend-dot.person {
            background: var(--color-ripper);
        }

        .network-legend-dot.place {
            background: var(--color-shawville);
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            background: var(--color-ink);
            color: white;
            padding: 0.75rem;
            border-radius: 4px;
            font-size: 0.85rem;
            pointer-events: none;
            z-index: 100;
            display: none;
            max-width: 250px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .tooltip.visible {
            display: block;
        }

        /* Space Invasion Chart */
        .space-invasion-container {
            margin: 2rem 0;
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        #space-invasion-svg {
            width: 100%;
            height: 500px;
        }

        .space-invasion-legend {
            display: flex;
            gap: 2rem;
            justify-content: center;
            margin-top: 1.5rem;
            flex-wrap: wrap;
            padding: 1rem;
            background: #f9f9f9;
            border-radius: 4px;
        }

        .space-legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .space-legend-box {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }

        .area-whitechapel { fill: var(--color-ripper); opacity: 0.8; }
        .area-burke { fill: #8B4513; opacity: 0.8; }
        .area-crime { fill: #4682B4; opacity: 0.7; }
        .area-local { fill: var(--color-shawville); opacity: 0.7; }
        .area-other { fill: #d4c5a9; opacity: 0.6; }

        .axis-label {
            font-size: 0.9rem;
            fill: var(--color-ink-light);
        }

        /* OCR Warning */
        .ocr-warning {
            background: #fff9e6;
            border-left: 4px solid #f39c12;
            padding: 1.5rem;
            margin: 2rem 0;
            border-radius: 4px;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .ocr-warning strong {
            color: #d68910;
            font-size: 1.05rem;
        }

        /* Floating Notepad */
        .notepad-toggle {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--color-ripper);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.3s;
            z-index: 999;
        }

        .notepad-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
        }

        .notepad-container {
            position: fixed;
            bottom: 100px;
            right: 2rem;
            width: 350px;
            max-height: 500px;
            background: var(--color-paper);
            border: 2px solid var(--color-ink);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
            z-index: 1000;
            font-family: 'Crimson Text', serif;
        }

        .notepad-container.active {
            display: flex;
        }

        .notepad-header {
            background: var(--color-ink);
            color: var(--color-paper);
            padding: 0.75rem 1rem;
            border-radius: 6px 6px 0 0;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Playfair Display', serif;
            font-weight: 700;
        }

        .notepad-header-title {
            font-size: 1.1rem;
        }

        .notepad-close {
            background: none;
            border: none;
            color: var(--color-paper);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: color 0.3s;
        }

        .notepad-close:hover {
            color: var(--color-ripper);
        }

        .notepad-body {
            padding: 1rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .notepad-textarea {
            flex: 1;
            min-height: 300px;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Crimson Text', serif;
            font-size: 1rem;
            line-height: 1.6;
            resize: vertical;
        }

        .notepad-textarea:focus {
            outline: none;
            border-color: var(--color-ripper);
        }

        .notepad-actions {
            display: flex;
            gap: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #ddd;
        }

        .notepad-btn {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #ccc;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            font-family: 'Crimson Text', serif;
        }

        .notepad-btn:hover {
            background: var(--color-ink);
            color: white;
        }

        .notepad-btn.export {
            background: var(--color-shawville);
            color: white;
            border-color: var(--color-shawville);
        }

        .notepad-btn.export:hover {
            background: #1a6e1a;
        }

        .notepad-info {
            font-size: 0.8rem;
            color: var(--color-ink-light);
            font-style: italic;
            text-align: center;
        }

        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            .article-grid { grid-template-columns: 1fr; }
            .modal-content { padding: 1rem; }
        }
    </style>
</head>
<body>
    <header>
        <h1>Whitechapel in Shawville</h1>
        <p class="subtitle">How Jack the Ripper's murders reached rural Quebec, 1888-1895</p>
    </header>

    <div class="container">
        <!-- Statistics -->
        <div class="section">
            <h2>The Intrusion</h2>
            <div class="stats" id="stats">
                <div class="stat-box">
                    <div class="stat-number" id="stat-london">-</div>
                    <div class="stat-label">London Events</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="stat-shawville">-</div>
                    <div class="stat-label">Shawville Reports</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="stat-pages">-</div>
                    <div class="stat-label">Newspaper Pages</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="stat-days">-</div>
                    <div class="stat-label">Average Delay (days)</div>
                </div>
            </div>
        </div>

        <!-- Crime Comparison -->
        <div class="section">
            <h2>Murder Stories in The Equity</h2>
            <p style="margin-bottom: 2rem; color: var(--color-ink-light);">
                How did The Equity frame different types of murder coverage?
            </p>
            <div class="stats">
                <div class="stat-box" style="border: 2px solid var(--color-ripper);">
                    <div class="stat-number" id="stat-whitechapel" style="color: var(--color-ripper);">-</div>
                    <div class="stat-label">Whitechapel/Ripper<br><small style="font-size: 0.8rem;">London, 1888-1895</small></div>
                </div>
                <div class="stat-box" style="border: 2px solid #8B4513;">
                    <div class="stat-number" id="stat-burke" style="color: #8B4513;">-</div>
                    <div class="stat-label">Burke & Hare<br><small style="font-size: 0.8rem;">Edinburgh, 1828</small></div>
                </div>
                <div class="stat-box" style="border: 2px solid #2F4F4F;">
                    <div class="stat-number" id="stat-crime">-</div>
                    <div class="stat-label">General Crime<br><small style="font-size: 0.8rem;">Various locations</small></div>
                </div>
                <div class="stat-box" style="border: 2px solid var(--color-shawville);">
                    <div class="stat-number" id="stat-local-violence" style="color: var(--color-shawville);">-</div>
                    <div class="stat-label">Local Violence<br><small style="font-size: 0.8rem;">Shawville/Pontiac</small></div>
                </div>
            </div>
            <div style="margin-top: 1.5rem; padding: 1rem; background: #fff9e6; border-left: 4px solid #8B4513; border-radius: 4px;">
                <strong>October 25, 1888:</strong> The Equity ran 7 articles about Burke & Hare (Edinburgh body snatchers, 1828)
                during the height of the Ripper murders. Historical horror alongside contemporary terror.
            </div>
        </div>

        <!-- Word Cloud -->
        <div class="section">
            <h2>The Language of Horror</h2>
            <p style="margin-bottom: 1.5rem; color: var(--color-ink-light); font-style: italic; font-size: 1.1rem;">
                What words defined the Ripper coverage? These are the most frequent terms from Whitechapel articles‚Äîhover to see how many times each appeared.
            </p>
            <div class="word-cloud" id="word-cloud">
                <div class="loading">Loading word cloud...</div>
            </div>
        </div>

        <!-- Geographic Map -->
        <div class="section">
            <h2>Geography of News</h2>
            <p style="margin-bottom: 1rem; color: var(--color-ink-light);">
                Where did The Equity's stories originate? Click a location to filter articles.
            </p>
            <div class="geo-map" id="geo-map">
                <div class="loading">Analyzing locations...</div>
            </div>
        </div>

        <!-- Network Visualization -->
        <div class="section">
            <h2>People & Places Network</h2>
            <p style="margin-bottom: 1rem; color: var(--color-ink-light);">
                Who was connected to where, and to whom? This network shows people (red) and places (green) mentioned together in articles.
                Solid lines connect people to places, while dashed gold lines show people mentioned together.
                Node size reflects frequency of mentions.
            </p>
            <div class="network-controls">
                <button class="network-control-btn active" data-network-filter="all">All Connections</button>
                <button class="network-control-btn" data-network-filter="whitechapel">Whitechapel Only</button>
                <button class="network-control-btn" data-network-filter="burke">Burke & Hare</button>
                <button class="network-control-btn" id="reset-zoom-btn" style="margin-left: auto; background: #f0f0f0;">Reset View</button>
                <button class="network-control-btn" id="download-csv-btn" style="background: var(--color-shawville); color: white;">Download CSV</button>
                <span style="color: var(--color-ink-light); font-size: 0.85rem; margin-left: 1rem;">
                    <strong>Tip:</strong> Click nodes to highlight connections, drag to rearrange, scroll to zoom
                </span>
            </div>
            <div class="network-container">
                <svg id="network-svg"></svg>
            </div>
            <div class="network-legend">
                <div class="network-legend-item">
                    <div class="network-legend-dot person"></div>
                    <span>People (names mentioned)</span>
                </div>
                <div class="network-legend-item">
                    <div class="network-legend-dot place"></div>
                    <span>Places (locations mentioned)</span>
                </div>
                <div class="network-legend-item">
                    <svg width="30" height="2" style="margin-right: 0.5rem;">
                        <line x1="0" y1="1" x2="30" y2="1" stroke="#999" stroke-width="2" />
                    </svg>
                    <span>Person-Place connection</span>
                </div>
                <div class="network-legend-item">
                    <svg width="30" height="2" style="margin-right: 0.5rem;">
                        <line x1="0" y1="1" x2="30" y2="1" stroke="#d4af37" stroke-width="2" stroke-dasharray="3,3" />
                    </svg>
                    <span>Person-Person connection</span>
                </div>
                <div class="network-legend-item">
                    <span style="color: var(--color-ink-light);">
                        Line thickness = number of co-occurrences
                    </span>
                </div>
            </div>
        </div>

        <!-- Space Invasion -->
        <div class="section">
            <h2>The Invasion: How Much Space Did Horror Claim?</h2>
            <p style="margin-bottom: 1.5rem; color: var(--color-ink-light); font-style: italic; font-size: 1.1rem;">
                Between 1888 and 1895, Whitechapel murders and Burke & Hare retrospectives "invaded" The Equity's pages.
                This chart shows the proportion of content devoted to different topics over time.
                Watch how distant horrors flood local news space‚Äîespecially in autumn 1888.
            </p>
            <div class="space-invasion-container">
                <svg id="space-invasion-svg"></svg>
            </div>
            <div class="space-invasion-legend">
                <div class="space-legend-item">
                    <div class="space-legend-box" style="background: var(--color-ripper);"></div>
                    <span>Whitechapel/Ripper</span>
                </div>
                <div class="space-legend-item">
                    <div class="space-legend-box" style="background: #8B4513;"></div>
                    <span>Burke & Hare</span>
                </div>
                <div class="space-legend-item">
                    <div class="space-legend-box" style="background: #4682B4;"></div>
                    <span>General Crime</span>
                </div>
                <div class="space-legend-item">
                    <div class="space-legend-box" style="background: var(--color-shawville);"></div>
                    <span>Local Violence</span>
                </div>
                <div class="space-legend-item">
                    <div class="space-legend-box" style="background: #d4c5a9;"></div>
                    <span>Other Content</span>
                </div>
            </div>
        </div>

        <!-- Articles -->
        <div class="section">
            <h2>The Articles</h2>

            <!-- OCR Warning -->
            <div class="ocr-warning">
                <strong>‚ö†Ô∏è Note on OCR Quality:</strong> The best OCR would be to get a commercial grade vision model to examine all of these snippets. I am experimenting with pytesseract and the surya model. You will see some quite odd things! Always check the original snippets.
            </div>

            <div class="filters">
                <button class="filter-btn active" data-filter="whitechapel">Whitechapel/Ripper</button>
                <button class="filter-btn" data-filter="burke">Burke & Hare</button>
                <button class="filter-btn" data-filter="crime">General Crime</button>
                <button class="filter-btn" data-filter="local-violence">Local Violence</button>
                <button class="filter-btn" data-filter="all">All Articles</button>
            </div>
            <div class="article-grid" id="articles">
                <div class="loading">Loading articles...</div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <div id="modal-body"></div>
        </div>
    </div>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip"></div>

    <!-- Floating Notepad -->
    <button class="notepad-toggle" id="notepad-toggle" title="Toggle Research Notes">
        üìù
    </button>

    <div class="notepad-container" id="notepad-container">
        <div class="notepad-header" id="notepad-header">
            <div class="notepad-header-title">Research Notes</div>
            <button class="notepad-close" id="notepad-close">&times;</button>
        </div>
        <div class="notepad-body">
            <textarea class="notepad-textarea" id="notepad-textarea" placeholder="Take notes about your observations...

You can write freely here. Your notes are automatically saved to your browser."></textarea>
            <div class="notepad-info">Notes automatically saved ‚Ä¢ Drag header to move</div>
            <div class="notepad-actions">
                <button class="notepad-btn" id="notepad-clear">Clear</button>
                <button class="notepad-btn export" id="notepad-export">Export as TXT</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let timelineData = null;
        let articlesData = null;
        let textAnalysisData = null;
        let entitiesData = null; // Precomputed entities
        let currentFilter = 'whitechapel';
        let locationFilter = null;
        let currentNetworkData = null; // Store current network data for CSV export
        let currentSimulation = null; // Store D3 simulation for controls

        // Helper: Detect Burke & Hare articles
        function isBurkeHare(article) {
            const text = article.full_text?.toLowerCase() || '';
            const headline = article.headline?.toLowerCase() || '';
            // Must mention both Burke AND Hare, or have body snatcher context
            return ((text.includes('burke') && text.includes('hare')) ||
                    (headline.includes('burke') || headline.includes('hare')) ||
                    (text.includes('body') && text.includes('snatcher')));
        }

        // Helper: Detect local violence
        function isLocalViolence(article) {
            const isWhitechapel = article.is_whitechapel || article.is_ripper_related;
            const isLocal = article.tags?.some(t => t.tag === 'local_shawville');
            const text = article.full_text?.toLowerCase() || '';
            const violenceKeywords = ['murder', 'kill', 'assault', 'attack', 'shot', 'stabbed', 'beaten'];
            return !isWhitechapel && isLocal && violenceKeywords.some(k => text.includes(k));
        }

        // Helper: Detect general crime
        function isGeneralCrime(article) {
            const isWhitechapel = article.is_whitechapel || article.is_ripper_related;
            if (isWhitechapel || isBurkeHare(article)) return false;
            return article.tags?.some(t => t.tag === 'crime_general');
        }

        // Helper: Extract locations mentioned in article
        function extractLocations(article) {
            // Use precomputed entities if available
            if (entitiesData && entitiesData.article_entities) {
                const articleEntities = entitiesData.article_entities[article.article_id];
                if (articleEntities && articleEntities.places) {
                    return articleEntities.places;
                }
            }

            // Fallback to regex extraction
            const text = (article.full_text || '').toLowerCase();
            const headline = (article.headline || '').toLowerCase();
            const combined = text + ' ' + headline;

            const locations = [];
            const locationPatterns = {
                // Major international cities
                'London': /\blondon\b/i,
                'Whitechapel': /\bwhitechapel\b/i,
                'Edinburgh': /\bedinburgh\b/i,
                'Paris': /\bparis\b/i,
                'New York': /\bnew york\b/i,
                'United States': /\bunited states\b/i,

                // Countries and regions
                'England': /\bengland\b/i,
                'Scotland': /\bscotland\b/i,
                'Ireland': /\bireland\b/i,

                // Canadian major cities
                'Ottawa': /\bottawa\b/i,
                'Toronto': /\btoronto\b/i,
                'Montreal': /\bmontreal\b/i,
                'Quebec City': /\bquebec city\b/i,
                'Quebec': /\bquebec\b/i,

                // Pontiac County and nearby communities
                'Shawville': /\bshawville\b/i,
                'Pontiac': /\bpontiac\b/i,
                'Aylmer': /\baylmer\b/i,
                'Hull': /\bhull\b/i,
                'Bryson': /\bbryson\b/i,
                'Campbell\'s Bay': /\bcampbell'?s?\s+bay\b/i,
                'Fort Coulonge': /\bfort\s+coulonge\b/i,
                'Portage-du-Fort': /\bportage[- ]du[- ]fort\b/i,
                'Quyon': /\bquyon\b/i,
                'Bristol': /\bbristol\b/i,
                'Litchfield': /\blitchfield\b/i,
                'Clarendon': /\bclarendon\b/i,
                'Thorne': /\bthorne\b/i,
                'Alleyn': /\balleyn\b/i,
                'Calumet': /\bcalumet\b/i,
                'Chapeau': /\bchapeau\b/i,
                'Norway Bay': /\bnorway\s+bay\b/i,
                'Pembroke': /\bpembroke\b/i,
                'Renfrew': /\brenfrew\b/i,
                'Arnprior': /\barnprior\b/i,
                'Eganville': /\beganville\b/i
            };

            for (const [location, pattern] of Object.entries(locationPatterns)) {
                if (pattern.test(combined)) {
                    locations.push(location);
                }
            }

            return locations;
        }

        // Helper: Extract person names from article
        function extractPeople(article) {
            // Use precomputed entities if available
            if (entitiesData && entitiesData.article_entities) {
                const articleEntities = entitiesData.article_entities[article.article_id];
                if (articleEntities && articleEntities.people) {
                    return articleEntities.people;
                }
            }

            // Fallback to regex extraction
            const text = article.full_text || '';
            const headline = article.headline || '';
            const combined = text + ' ' + headline;

            const people = new Set();

            // Known names from Whitechapel murders
            const knownNames = {
                'Jack': /\bjack\b.*\bripper\b/i,
                'Jack the Ripper': /\bjack\s+(?:the\s+)?ripper\b/i,
                'Mary Ann Nichols': /\bmary\s+ann\s+nichols\b/i,
                'Annie Chapman': /\bannie\s+chapman\b/i,
                'Elizabeth Stride': /\belizabeth\s+stride\b/i,
                'Catherine Eddowes': /\bcatherine\s+eddowes\b/i,
                'Mary Jane Kelly': /\bmary\s+jane\s+kelly\b/i,
                'Burke': /\bburke\b/i,
                'Hare': /\bhare\b/i,
                'Dr. Burke': /\bdr\.?\s+burke\b/i,
                'William Burke': /\bwilliam\s+burke\b/i
            };

            for (const [name, pattern] of Object.entries(knownNames)) {
                if (pattern.test(combined)) {
                    people.add(name);
                }
            }

            // Extract capitalized multi-word names (2-3 words)
            // Pattern: Capital Letter + lowercase letters, repeated 2-3 times
            const namePattern = /\b([A-Z][a-z]+(?:\s+[A-Z][a-z]+){1,2})\b/g;
            let match;

            const stopWords = new Set([
                'The', 'This', 'That', 'These', 'Those', 'He', 'She', 'His', 'Her',
                'They', 'Their', 'What', 'When', 'Where', 'Who', 'Why', 'How',
                'There', 'Here', 'Then', 'Now', 'Very', 'More', 'Most', 'Some',
                'Many', 'Such', 'Other', 'Another', 'Each', 'Every', 'All', 'Both',
                'New York', 'United States', 'Great Britain', 'North America',
                'Last Week', 'Last Night', 'Next Week', 'Next Month',
                'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday',
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December',
                // Article metadata and common phrases to exclude
                'Untitled Snippet', 'Article From', 'The Equity', 'Per Cent', 'Last Year',
                'Next Year', 'This Week', 'This Month', 'This Year', 'Last Month',
                'Young Man', 'Old Man', 'The Man', 'The Woman', 'The Girl', 'The Boy',
                'Police Station', 'Post Office', 'City Hall', 'Town Hall', 'Main Street'
            ]);

            while ((match = namePattern.exec(combined)) !== null) {
                const name = match[1];
                if (!stopWords.has(name) && name.length > 4) {
                    people.add(name);
                }
            }

            return Array.from(people).slice(0, 10); // Limit to top 10 per article
        }

        // Build network data from articles
        function buildNetworkData(articles) {
            const nodes = new Map();
            const links = new Map();

            articles.forEach(article => {
                const people = extractPeople(article);
                const places = extractLocations(article);

                // Create person nodes
                people.forEach(person => {
                    if (!nodes.has(person)) {
                        nodes.set(person, { id: person, type: 'person', count: 0 });
                    }
                    nodes.get(person).count++;
                });

                // Create place nodes
                places.forEach(place => {
                    if (!nodes.has(place)) {
                        nodes.set(place, { id: place, type: 'place', count: 0 });
                    }
                    nodes.get(place).count++;
                });

                // Create links between people and places in same article
                people.forEach(person => {
                    places.forEach(place => {
                        const linkId = `${person}|${place}`;
                        if (!links.has(linkId)) {
                            links.set(linkId, {
                                source: person,
                                target: place,
                                value: 0,
                                linkType: 'person-place'
                            });
                        }
                        links.get(linkId).value++;
                    });
                });

                // Create links between people mentioned in same article
                for (let i = 0; i < people.length; i++) {
                    for (let j = i + 1; j < people.length; j++) {
                        const person1 = people[i];
                        const person2 = people[j];
                        // Sort names to create consistent link IDs
                        const [source, target] = [person1, person2].sort();
                        const linkId = `${source}|${target}`;

                        if (!links.has(linkId)) {
                            links.set(linkId, {
                                source: source,
                                target: target,
                                value: 0,
                                linkType: 'person-person'
                            });
                        }
                        links.get(linkId).value++;
                    }
                }
            });

            // Filter to keep only nodes with meaningful connections (at least 2 mentions)
            const nodesArray = Array.from(nodes.values()).filter(n => n.count >= 2);
            const nodeIds = new Set(nodesArray.map(n => n.id));
            const linksArray = Array.from(links.values())
                .filter(l => nodeIds.has(l.source) && nodeIds.has(l.target))
                .filter(l => l.value >= 1);

            return { nodes: nodesArray, links: linksArray };
        }

        // Download network as CSV
        function downloadNetworkCSV() {
            if (!currentNetworkData || !currentNetworkData.links) {
                alert('No network data available to download');
                return;
            }

            // Build CSV content
            let csv = 'source,target,type,weight\n';
            currentNetworkData.links.forEach(link => {
                const source = typeof link.source === 'object' ? link.source.id : link.source;
                const target = typeof link.target === 'object' ? link.target.id : link.target;
                const type = link.linkType || 'unknown';
                csv += `"${source}","${target}","${type}",${link.value}\n`;
            });

            // Create download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'social-network.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Load data
        async function loadData() {
            try {
                // Try to load precomputed entities (optional)
                try {
                    const entities = await fetch('data/processed/entities.json').then(r => r.json());
                    entitiesData = entities;
                    console.log('Loaded precomputed entities:', entitiesData);
                    console.log('Using NER-based entity extraction');
                } catch (e) {
                    console.log('No precomputed entities found, using regex fallback');
                    entitiesData = null;
                }

                const [timeline, articles, textAnalysis] = await Promise.all([
                    fetch('data/processed/timeline.json').then(r => r.json()),
                    fetch('data/processed/tagged_articles.json').then(r => r.json()),
                    fetch('data/processed/text_analysis.json').then(r => r.json())
                ]);

                timelineData = timeline;
                articlesData = articles.articles;
                textAnalysisData = textAnalysis;

                console.log('Loaded timeline:', timeline);
                console.log('Loaded articles:', articlesData.length);
                console.log('Loaded text analysis:', textAnalysis);

                renderStats();
                renderWordCloud();
                renderGeoMap();
                renderNetwork('all');
                renderSpaceInvasion();
                renderArticles();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('timeline').innerHTML = '<p style="color: red;">Error loading data. Check console.</p>';
            }
        }

        // Render statistics
        function renderStats() {
            const whitechapelArticles = articlesData.filter(a => a.is_whitechapel || a.is_ripper_related);
            const burkeHareArticles = articlesData.filter(isBurkeHare);
            const crimeArticles = articlesData.filter(isGeneralCrime);
            const localViolenceArticles = articlesData.filter(isLocalViolence);

            const pages = new Set(whitechapelArticles.map(a => `${a.source_pdf}_p${a.page_number}`)).size;
            const avgDelay = timelineData.shawville_events.reduce((sum, e) => sum + e.time_lag_days, 0) / timelineData.shawville_events.length;

            document.getElementById('stat-london').textContent = timelineData.london_events.length;
            document.getElementById('stat-shawville').textContent = timelineData.shawville_events.length;
            document.getElementById('stat-pages').textContent = pages;
            document.getElementById('stat-days').textContent = Math.round(avgDelay);

            // Crime comparison stats
            document.getElementById('stat-whitechapel').textContent = whitechapelArticles.length;
            document.getElementById('stat-burke').textContent = burkeHareArticles.length;
            document.getElementById('stat-crime').textContent = crimeArticles.length;
            document.getElementById('stat-local-violence').textContent = localViolenceArticles.length;
        }

        // Render word cloud
        function renderWordCloud() {
            const container = document.getElementById('word-cloud');

            // Get top 50 words from word cloud data
            const words = textAnalysisData.word_cloud_data.slice(0, 50);

            // Calculate font size range
            const maxSize = words[0].size;
            const minSize = words[words.length - 1].size;

            let html = '';
            words.forEach(word => {
                // Scale font size from 0.9rem to 3.5rem with more dramatic variation
                const scale = (word.size - minSize) / (maxSize - minSize);
                const fontSize = 0.9 + (scale * 2.6);
                const opacity = 0.6 + (scale * 0.4);

                html += `<span style="font-size: ${fontSize}rem; opacity: ${opacity};"
                              title="${word.text}: ${word.size} occurrences">${word.text}</span>`;
            });

            container.innerHTML = html;
        }

        // Render geographic map
        function renderGeoMap() {
            const container = document.getElementById('geo-map');

            // Count articles by location
            const locationCounts = {};
            articlesData.forEach(article => {
                const locations = extractLocations(article);
                locations.forEach(loc => {
                    locationCounts[loc] = (locationCounts[loc] || 0) + 1;
                });
            });

            // Sort and group key locations
            const keyLocations = [
                { name: 'London/Whitechapel', key: 'london', desc: 'Ripper murders & British news',
                  count: (locationCounts['London'] || 0) + (locationCounts['Whitechapel'] || 0) },
                { name: 'Edinburgh', key: 'edinburgh', desc: 'Burke & Hare historical murders',
                  count: locationCounts['Edinburgh'] || 0 },
                { name: 'Shawville', key: 'shawville', desc: 'Local Pontiac County news',
                  count: locationCounts['Shawville'] || 0 },
                { name: 'United States', key: 'international', desc: 'American news & events',
                  count: locationCounts['United States'] || 0 },
                { name: 'Canadian Cities', key: 'canadian', desc: 'Ottawa, Montreal, Toronto, Quebec',
                  count: (locationCounts['Ottawa'] || 0) + (locationCounts['Montreal'] || 0) +
                         (locationCounts['Toronto'] || 0) + (locationCounts['Quebec'] || 0) }
            ];

            const maxCount = Math.max(...keyLocations.map(l => l.count));

            let html = '';
            keyLocations.forEach(location => {
                const percentage = (location.count / maxCount) * 100;
                html += `
                    <div class="location-box ${location.key}" data-location="${location.name}">
                        <div class="location-name">${location.name}</div>
                        <div class="location-count">${location.count}</div>
                        <div class="location-desc">${location.desc}</div>
                        <div class="location-bar">
                            <div class="location-bar-fill" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

            // Add click handlers to filter by location
            document.querySelectorAll('.location-box').forEach(box => {
                box.addEventListener('click', () => {
                    const location = box.dataset.location;
                    filterByLocation(location);
                });
            });
        }

        // Filter articles by location
        function filterByLocation(location) {
            locationFilter = location;
            currentFilter = 'location';

            // Update filter button display
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));

            renderArticles();

            // Scroll to articles section
            document.getElementById('articles').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Render network visualization
        function renderNetwork(filter = 'all') {
            const svg = d3.select('#network-svg');
            svg.selectAll('*').remove(); // Clear existing

            const width = svg.node().clientWidth;
            const height = 600;

            // Filter articles based on selection
            let filteredArticles = articlesData;
            if (filter === 'whitechapel') {
                filteredArticles = articlesData.filter(a => a.is_whitechapel || a.is_ripper_related);
            } else if (filter === 'burke') {
                filteredArticles = articlesData.filter(isBurkeHare);
            }

            // Build network data
            const { nodes, links } = buildNetworkData(filteredArticles);

            // Store for CSV export
            currentNetworkData = { nodes, links };

            console.log(`Network: ${nodes.length} nodes, ${links.length} links`);

            if (nodes.length === 0) {
                svg.append('text')
                    .attr('x', width / 2)
                    .attr('y', height / 2)
                    .attr('text-anchor', 'middle')
                    .text('No network data available for this filter')
                    .style('fill', '#999');
                currentNetworkData = null;
                return;
            }

            // Create zoom behavior
            const g = svg.append('g');

            const zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });

            svg.call(zoom);

            // Store initial transform for reset
            const initialTransform = d3.zoomIdentity.translate(0, 0).scale(1);

            // Create force simulation
            const simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(d => Math.sqrt(d.count) * 5 + 10));

            // Store simulation for controls
            currentSimulation = simulation;

            // Create link elements
            const link = g.append('g')
                .selectAll('line')
                .data(links)
                .join('line')
                .attr('class', d => `network-link ${d.linkType}`)
                .attr('stroke-width', d => Math.sqrt(d.value) * 0.5);

            // Create node elements
            const node = g.append('g')
                .selectAll('circle')
                .data(nodes)
                .join('circle')
                .attr('class', d => `network-node ${d.type}`)
                .attr('r', d => Math.sqrt(d.count) * 3 + 5)
                .attr('stroke-width', 2)
                .call(drag(simulation));

            // Add labels
            const label = g.append('g')
                .selectAll('text')
                .data(nodes)
                .join('text')
                .attr('class', 'network-label')
                .attr('text-anchor', 'middle')
                .attr('dy', d => Math.sqrt(d.count) * 3 + 18)
                .text(d => d.id);

            // Add interactivity
            node.on('click', function(event, d) {
                // Highlight connected nodes
                const connectedNodes = new Set();
                connectedNodes.add(d.id);

                links.forEach(l => {
                    if (l.source.id === d.id) connectedNodes.add(l.target.id);
                    if (l.target.id === d.id) connectedNodes.add(l.source.id);
                });

                node.style('opacity', n => connectedNodes.has(n.id) ? 1 : 0.1);
                link.style('opacity', l =>
                    l.source.id === d.id || l.target.id === d.id ? 0.6 : 0.05
                );
                label.style('opacity', n => connectedNodes.has(n.id) ? 1 : 0.1);
            });

            svg.on('click', function(event) {
                if (event.target === this) {
                    // Reset on background click
                    node.style('opacity', 1);
                    link.style('opacity', 0.3);
                    label.style('opacity', 1);
                }
            });

            // Setup reset zoom button
            d3.select('#reset-zoom-btn').on('click', function() {
                svg.transition().duration(750).call(
                    zoom.transform,
                    initialTransform
                );
            });

            // Add tooltip
            node.on('mouseover', function(event, d) {
                const tooltip = d3.select('#tooltip');
                tooltip.html(`
                    <strong>${d.id}</strong><br>
                    Type: ${d.type}<br>
                    Mentions: ${d.count}
                `);
                tooltip.style('display', 'block')
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY + 10) + 'px');
            });

            node.on('mouseout', function() {
                d3.select('#tooltip').style('display', 'none');
            });

            // Update positions on tick
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);

                label
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });

            // Drag behavior
            function drag(simulation) {
                function dragstarted(event) {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    event.subject.fx = event.subject.x;
                    event.subject.fy = event.subject.y;
                }

                function dragged(event) {
                    event.subject.fx = event.x;
                    event.subject.fy = event.y;
                }

                function dragended(event) {
                    if (!event.active) simulation.alphaTarget(0);
                    event.subject.fx = null;
                    event.subject.fy = null;
                }

                return d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended);
            }
        }

        // Render Space Invasion visualization
        function renderSpaceInvasion() {
            const svg = d3.select('#space-invasion-svg');
            svg.selectAll('*').remove();

            const margin = { top: 20, right: 20, bottom: 60, left: 60 };
            const width = svg.node().clientWidth - margin.left - margin.right;
            const height = 500 - margin.top - margin.bottom;

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Group articles by month and categorize
            const monthlyData = d3.rollup(
                articlesData,
                articles => {
                    const whitechapel = articles.filter(a => a.is_whitechapel || a.is_ripper_related);
                    const burke = articles.filter(isBurkeHare);
                    const crime = articles.filter(isGeneralCrime);
                    const local = articles.filter(isLocalViolence);
                    const other = articles.filter(a =>
                        !whitechapel.includes(a) && !burke.includes(a) &&
                        !crime.includes(a) && !local.includes(a)
                    );

                    return {
                        whitechapel: d3.sum(whitechapel, d => d.word_count || 0),
                        burke: d3.sum(burke, d => d.word_count || 0),
                        crime: d3.sum(crime, d => d.word_count || 0),
                        local: d3.sum(local, d => d.word_count || 0),
                        other: d3.sum(other, d => d.word_count || 0)
                    };
                },
                d => {
                    const date = new Date(d.date);
                    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                }
            );

            // Convert to array and sort by date
            const dataArray = Array.from(monthlyData, ([key, value]) => ({
                date: new Date(key + '-01'),
                ...value
            })).sort((a, b) => a.date - b.date);

            // Calculate percentages
            dataArray.forEach(d => {
                const total = d.whitechapel + d.burke + d.crime + d.local + d.other;
                d.whitechapelPct = total > 0 ? (d.whitechapel / total) * 100 : 0;
                d.burkePct = total > 0 ? (d.burke / total) * 100 : 0;
                d.crimePct = total > 0 ? (d.crime / total) * 100 : 0;
                d.localPct = total > 0 ? (d.local / total) * 100 : 0;
                d.otherPct = total > 0 ? (d.other / total) * 100 : 0;
            });

            // Scales
            const x = d3.scaleTime()
                .domain(d3.extent(dataArray, d => d.date))
                .range([0, width]);

            const y = d3.scaleLinear()
                .domain([0, 100])
                .range([height, 0]);

            // Stack the data
            const stack = d3.stack()
                .keys(['otherPct', 'localPct', 'crimePct', 'burkePct', 'whitechapelPct'])
                .order(d3.stackOrderNone)
                .offset(d3.stackOffsetNone);

            const stackedData = stack(dataArray);

            // Area generator
            const area = d3.area()
                .x(d => x(d.data.date))
                .y0(d => y(d[0]))
                .y1(d => y(d[1]))
                .curve(d3.curveMonotoneX);

            // Color mapping
            const colorMap = {
                'whitechapelPct': 'area-whitechapel',
                'burkePct': 'area-burke',
                'crimePct': 'area-crime',
                'localPct': 'area-local',
                'otherPct': 'area-other'
            };

            // Draw areas
            g.selectAll('.area')
                .data(stackedData)
                .join('path')
                .attr('class', d => colorMap[d.key] || 'area-other')
                .attr('d', area)
                .append('title')
                .text(d => d.key.replace('Pct', ''));

            // Add axes
            const xAxis = d3.axisBottom(x)
                .ticks(d3.timeYear.every(1))
                .tickFormat(d3.timeFormat('%Y'));

            const yAxis = d3.axisLeft(y)
                .ticks(5)
                .tickFormat(d => d + '%');

            g.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(xAxis)
                .selectAll('text')
                .attr('transform', 'rotate(-45)')
                .style('text-anchor', 'end');

            g.append('g')
                .call(yAxis);

            // Axis labels
            g.append('text')
                .attr('class', 'axis-label')
                .attr('transform', 'rotate(-90)')
                .attr('y', -45)
                .attr('x', -height / 2)
                .attr('text-anchor', 'middle')
                .text('Percentage of Content');

            g.append('text')
                .attr('class', 'axis-label')
                .attr('x', width / 2)
                .attr('y', height + 50)
                .attr('text-anchor', 'middle')
                .text('Publication Date');

            console.log('Space invasion visualization rendered with', dataArray.length, 'data points');
        }

        // Render articles
        function renderArticles() {
            const container = document.getElementById('articles');
            let filtered = articlesData;

            // Apply filter
            if (currentFilter === 'whitechapel') {
                filtered = articlesData.filter(a => a.is_whitechapel || a.is_ripper_related);
            } else if (currentFilter === 'burke') {
                filtered = articlesData.filter(isBurkeHare);
            } else if (currentFilter === 'crime') {
                filtered = articlesData.filter(isGeneralCrime);
            } else if (currentFilter === 'local-violence') {
                filtered = articlesData.filter(isLocalViolence);
            } else if (currentFilter === 'location' && locationFilter) {
                filtered = articlesData.filter(a => {
                    const locations = extractLocations(a);
                    // Handle grouped locations
                    if (locationFilter === 'London/Whitechapel') {
                        return locations.includes('London') || locations.includes('Whitechapel');
                    } else if (locationFilter === 'Canadian Cities') {
                        return locations.some(l => ['Ottawa', 'Montreal', 'Toronto', 'Quebec'].includes(l));
                    } else {
                        return locations.includes(locationFilter);
                    }
                });
            }

            // Sort by date
            filtered.sort((a, b) => (a.date || '').localeCompare(b.date || ''));

            // Add filter heading
            let filterHeading = '';
            if (currentFilter === 'location' && locationFilter) {
                filterHeading = `<p style="margin-bottom: 1rem; color: var(--color-ripper); font-weight: bold;">
                    Showing ${filtered.length} articles mentioning: ${locationFilter}
                    <button onclick="currentFilter='whitechapel'; locationFilter=null; renderArticles();"
                            style="margin-left: 1rem; padding: 0.5rem 1rem; cursor: pointer; border: 1px solid #ccc; background: white; border-radius: 4px;">
                        Clear filter
                    </button>
                </p>`;
            }

            let html = filterHeading;
            filtered.forEach(article => {
                const isWhitechapel = article.is_whitechapel || article.is_ripper_related;
                const isBH = isBurkeHare(article);
                const isLV = isLocalViolence(article);

                let badgeHtml = '';
                let cardClass = '';
                if (isWhitechapel) {
                    badgeHtml = '<div class="badge" style="background: var(--color-ripper);">Whitechapel/Ripper</div>';
                    cardClass = 'whitechapel';
                } else if (isBH) {
                    badgeHtml = '<div class="badge" style="background: #8B4513;">Burke & Hare</div>';
                    cardClass = 'burke-hare';
                } else if (isLV) {
                    badgeHtml = '<div class="badge" style="background: var(--color-shawville);">Local Violence</div>';
                    cardClass = 'local-violence';
                }

                html += `
                    <div class="article-card ${cardClass}"
                         data-id="${article.article_id}">
                        ${badgeHtml}
                        <h3>${article.headline || 'Untitled'}</h3>
                        <div class="meta">
                            ${article.date || 'Unknown date'} |
                            Page ${article.page_number} |
                            ${article.word_count} words
                        </div>
                        <div class="snippet">
                            ${article.full_text?.substring(0, 150)}${article.full_text?.length > 150 ? '...' : ''}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html || '<p>No articles match this filter.</p>';

            // Add click listeners
            document.querySelectorAll('.article-card').forEach(card => {
                card.addEventListener('click', () => {
                    const article = articlesData.find(a => a.article_id === card.dataset.id);
                    showArticleModal(article);
                });
            });
        }

        // Show article modal
        function showArticleModal(article) {
            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');

            const isWhitechapel = article.is_whitechapel || article.is_ripper_related;
            const imagePath = `data/preprocessed/${article.source_pdf}/${article.article_id}.jpg`;
            const locations = extractLocations(article);

            // Format locations as badges
            let locationBadges = '';
            if (locations.length > 0) {
                locationBadges = '<div style="margin: 1rem 0;"><strong>Locations mentioned:</strong> ';
                locations.forEach(loc => {
                    locationBadges += `<span style="display: inline-block; background: #e8e8e8; padding: 0.25rem 0.75rem; margin: 0.25rem; border-radius: 3px; font-size: 0.85rem;">${loc}</span>`;
                });
                locationBadges += '</div>';
            }

            body.innerHTML = `
                ${isWhitechapel ? '<div class="badge" style="margin-bottom: 1rem;">Whitechapel/Ripper Content</div>' : ''}
                <h2>${article.headline || 'Article from The Equity'}</h2>
                <div class="meta">
                    <strong>Date:</strong> ${article.date || 'Unknown'} |
                    <strong>Page:</strong> ${article.page_number} |
                    <strong>Column:</strong> ${article.column} |
                    <strong>Words:</strong> ${article.word_count}
                </div>
                ${locationBadges}

                <!-- View Toggle -->
                <div class="view-toggle">
                    <button class="view-toggle-btn active" data-view="image">
                        üì∑ Original Snippet
                    </button>
                    <button class="view-toggle-btn" data-view="transcription">
                        üìù OCR Transcription
                    </button>
                </div>

                <!-- Image View -->
                <div class="modal-view image-view active" id="image-view">
                    <img src="${imagePath}"
                         alt="Original article snippet from The Equity"
                         id="modal-image"
                         onerror="this.parentElement.innerHTML='<p style=\\'color: #999; padding: 2rem;\\'>Image not available for this article.</p>';">
                    <div class="image-caption">
                        Click image to zoom. Original newspaper snippet from The Equity.
                    </div>
                </div>

                <!-- Transcription View -->
                <div class="modal-view" id="transcription-view">
                    <h3 style="margin-top: 1rem; margin-bottom: 1rem;">OCR Transcription</h3>
                    <div class="text">${article.full_text}</div>
                </div>

                <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #ddd; font-size: 0.85rem; color: #999;">
                    Source: ${article.source_pdf} | ID: ${article.article_id}
                </div>
            `;

            // Add view toggle functionality
            const toggleBtns = body.querySelectorAll('.view-toggle-btn');
            toggleBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const viewType = this.dataset.view;

                    // Update button states
                    toggleBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    // Show/hide views
                    document.getElementById('image-view').classList.toggle('active', viewType === 'image');
                    document.getElementById('transcription-view').classList.toggle('active', viewType === 'transcription');
                });
            });

            // Add image zoom functionality
            const modalImage = body.querySelector('#modal-image');
            if (modalImage) {
                modalImage.addEventListener('click', function() {
                    this.classList.toggle('zoomed');
                });
            }

            modal.classList.add('active');
        }

        // Close modal
        document.querySelector('.modal-close').addEventListener('click', () => {
            document.getElementById('modal').classList.remove('active');
        });

        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target.id === 'modal') {
                document.getElementById('modal').classList.remove('active');
            }
        });

        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                renderArticles();
            });
        });

        // Network filter buttons
        document.querySelectorAll('.network-control-btn[data-network-filter]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.network-control-btn[data-network-filter]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const filter = btn.dataset.networkFilter;
                renderNetwork(filter);
            });
        });

        // CSV download button
        document.getElementById('download-csv-btn').addEventListener('click', downloadNetworkCSV);

        // Floating Notepad Functionality
        const notepadToggle = document.getElementById('notepad-toggle');
        const notepadContainer = document.getElementById('notepad-container');
        const notepadClose = document.getElementById('notepad-close');
        const notepadTextarea = document.getElementById('notepad-textarea');
        const notepadClear = document.getElementById('notepad-clear');
        const notepadExport = document.getElementById('notepad-export');
        const notepadHeader = document.getElementById('notepad-header');

        // Load saved notes from localStorage
        const savedNotes = localStorage.getItem('equity-research-notes');
        if (savedNotes) {
            notepadTextarea.value = savedNotes;
        }

        // Toggle notepad visibility
        notepadToggle.addEventListener('click', () => {
            const isVisible = notepadContainer.style.display === 'flex';
            notepadContainer.style.display = isVisible ? 'none' : 'flex';
        });

        // Close button
        notepadClose.addEventListener('click', () => {
            notepadContainer.style.display = 'none';
        });

        // Auto-save to localStorage on input
        notepadTextarea.addEventListener('input', () => {
            localStorage.setItem('equity-research-notes', notepadTextarea.value);
        });

        // Clear notes with confirmation
        notepadClear.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear all notes? This cannot be undone.')) {
                notepadTextarea.value = '';
                localStorage.removeItem('equity-research-notes');
            }
        });

        // Export notes as TXT file
        notepadExport.addEventListener('click', () => {
            const notes = notepadTextarea.value;
            if (!notes.trim()) {
                alert('No notes to export.');
                return;
            }

            const blob = new Blob([notes], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `equity-research-notes-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // Drag functionality
        let isDragging = false;
        let currentX;
        let currentY;
        let initialX;
        let initialY;
        let xOffset = 0;
        let yOffset = 0;

        notepadHeader.addEventListener('mousedown', dragStart);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', dragEnd);

        function dragStart(e) {
            if (e.target === notepadClose) return; // Don't drag when clicking close button

            initialX = e.clientX - xOffset;
            initialY = e.clientY - yOffset;

            if (e.target === notepadHeader || e.target.classList.contains('notepad-header-title')) {
                isDragging = true;
                notepadHeader.style.cursor = 'grabbing';
            }
        }

        function drag(e) {
            if (isDragging) {
                e.preventDefault();
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;

                xOffset = currentX;
                yOffset = currentY;

                setTranslate(currentX, currentY, notepadContainer);
            }
        }

        function dragEnd(e) {
            initialX = currentX;
            initialY = currentY;
            isDragging = false;
            notepadHeader.style.cursor = 'grab';
        }

        function setTranslate(xPos, yPos, el) {
            el.style.transform = `translate(${xPos}px, ${yPos}px)`;
        }

        // Initialize
        loadData();
    </script>
</body>
</html>
